---
layout: post
title:  "boot가 아직 준비되지 않았는데 기존 파드가 삭제될때"
date:   2024-01-28 11:00:00 +0900
tags: [k8s, kubernetes, boot, actuator, startupProbe]
---
>**새로운 버전을 배포 **할 때, <br>
>Deployment는** 최신 버전을 먼저 실행**하고, 실행이 완료되면 **이전 버전의 파드를 삭제**한다.<br>
>그러나 최신 버전의 파드는 정상적으로 실행됐지만 boot가 **아직 준비상태가 아닌데** <br>
>이전 버전의 **파드가 삭제**되면 최신 버전의 파드가 준비상태가 될 때 까지 **접속 장애**가 나타난다.<br>
>boot가 준비 **상태가 되어야만 파드가 실행 완료** 되었다고 간주하도록 설정해보자.

<br>

# Spring Boot 에서  `actuator` 적용하기

파드가 실행될 때 boot가 준비되었는지 확인하기 위한 endpoint를 만들어준다.

1. `actuator` 의존성 추가하기
``` maven
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

<br>

2. `actuator` 가 정상적으로 동작하는지 테스트
``` shell
$ curl localhost:8080/actuator/health
{"status":"up"}
```

<br>

# K8s Deployment `startupProbe` 추가하기

파드가 실행되면 `actuator` 로 추가한 준비상태 endpoint로 요청 후 응답을 받았을 때 파드가 정상 동작임으로 간주한다.<br>
<br>
(HTTP 상태코드가 200 ~ 400 상태 코드 사이의 값을 반환하면 정상,  400 ~ 500인 경우 오류)

```yaml
  startupProbe:
	httpGet: # http GET으로 요청
	  port: 80 # 요청할 웹포트
	  path: /actuator/health # 요청할 엔드포인트
	  httpHeaders:
	  - name: Host
	    value: probe-httpreq
	initialDelaySeconds: 60 # 초기 지연시간 (60초 기다린 후 최초 요청, default:0)
	periodSeconds: 10 # 재요청 대기 초 (최초 실패 후 10초마다 재요청) (timeoutSeconds 보다 커야함, default:10)
	timeoutSeconds: 2 # 2초동안 응답을 받지 못하면 실패로 간주 (periodSeconds 보다 작아야함, default:1)
	failureThreshold: 30 # 최대 30번 요청
	successThreshold: 1 # 1회 성공하면 컨테이너 상태를 성공으로 설정 (default : 1)
```


