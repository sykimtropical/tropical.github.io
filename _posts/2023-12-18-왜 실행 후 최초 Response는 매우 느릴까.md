---
layout: post
title:  "ì™œ ì‹¤í–‰ í›„ ìµœì´ˆ ResponseëŠ” ë§¤ìš° ëŠë¦´ê¹Œ"
date:   2023-12-18 11:00:00 +0900
tags: [coldstart, warmup, springboot, jvm]
lastmod : 2023-12-18 11:00:00 +0900
sitemap :
  changefreq : daily
  priority : 1.0
---
> ğŸ’¡í‚¤ì›Œë“œ <br>
> â€¢ Spring boot Warm up<br>
> â€¢ cold start

<br><br>

# í˜„ìƒ
Tomcat, Spring Boot ë“±ì˜ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰ í›„Â ìµœì´ˆë¡œ REST API ìš”ì²­ ì‹œ Response Timeì˜ ë”œë ˆì´ê°€ ë§ì´ ê¸´ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<br><br>

# ì´ìœ 
JVM í”„ë¡œì„¸ìŠ¤ê°€Â ì§€ì—°ë¡œë”© ë°©ì‹ì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ê¸° ë•Œë¬¸ì— ìµœì´ˆì˜ í•œë²ˆ ìš”ì²­í• ë•Œ ë¡œë“œë˜ëŠ” ê³¼ì • ë•Œë¬¸ì—Â ì§€ì—°ì‹œê°„ì´ ë°œìƒí•œë‹¤.
<br>
ë¡œë”©í•­ëª©ì€ ì•„ë˜ì™€ ê°™ë‹¤.
1. Bootstrap Class Loading : Javaì½”ë“œì™€ `java.lang.Object` ì™€ ê°™ì€ **í•„ìˆ˜ í´ë˜ìŠ¤**ë¥¼ ë©”ëª¨ë¦¬ì— ë¡œë“œ
2. Extension Class Loading : `java.ext.dirs` ê²½ë¡œì— ìˆëŠ” ëª¨ë“  JAR íŒŒì¼ì„ ë¡œë“œ (ê°œë°œìê°€  ìˆ˜ë™ìœ¼ë¡œ JAR íŒŒì¼ì„ ì¶”ê°€í•œ ê²½ìš°)
3. Application Class Loading : ì–´í”Œë¦¬ì¼€ì´ì…˜ í´ë˜ìŠ¤ ê²½ë¡œì— ìˆëŠ” **ëª¨ë“  í´ë˜ìŠ¤**ë¥¼ ë¡œë“œ
<br>
ìœ„ í´ë˜ìŠ¤ë¥¼ ëª¨ë‘ ì§ì ‘ ë¡œë”©ì‹œì¼œì£¼ë©´ cold start í˜„ìƒì„ ì—†ì•¨ ìˆ˜ ìˆëŠ”ë°, ì§ì ‘ ë¡œë”©ì‹œì¼œì£¼ê¸°ì—” ì–´ë ¤ì›€ì´ ìˆìœ¼ë‹ˆ <br>
ìµœì´ˆ ìš”ì²­ì„ bootì‹œ ì‹¤í–‰ë˜ë„ë¡ í•˜ì—¬ ì§€ì—°ë¡œë”©ì´ ì™„ë£Œë  ìˆ˜ ìˆë„ë¡ í•˜ë©´ ëœë‹¤.

<br><br>

# í•´ê²°ë°©ë²•
Spring Bootì—ì„œëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ì´Â ìµœì´ˆ ë¡œë”© ëœ í›„ í•œë²ˆ REST APIë¥¼ í˜¸ì¶œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ í•´ê²°í•œë‹¤. (ì›Œë¨¸ ë“±ë¡) <br>
ë˜í•œ 1ì‹œê°„ ì´ìƒ IDLE ìƒíƒœì— ë¹ ì ¸ìˆë‹¤ê°€ ìƒˆë¡œìš´ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ë™ì¼í•˜ê²Œ ì§€ì—°ë¡œë”©ìœ¼ë¡œ ì¸í•´ ë”œë ˆì´ê°€ ìƒê¸°ë¯€ë¡œ <br>
schedulerë¥¼ ë“±ë¡í•˜ì—¬ ì£¼ê¸°ì ìœ¼ë¡œ APIë¥¼ ìš”ì²­í•˜ì—¬ ê¹¨ìš°ëŠ” ë°©ë²•ë„ ì‚¬ìš©ëœë‹¤.<br>
<br><br>

>ì´ í˜„ìƒì€ ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ ëœ í›„ ìµœì´ˆ í•œë²ˆ ë˜ëŠ” <br>
>ì•„ì£¼ ì˜¤ëœ ì‹œê°„ë™ì•ˆ ìš”ì²­ì´ ì „í˜€ ì—†ì—ˆì„ ê²½ìš°(1ì‹œê°„ë™ì•ˆ IDLE ìƒíƒœì— ë¹ ì§€ë©´)ì—ë§Œ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— ê¼­ í•´ê²°í•´ì•¼í•˜ëŠ” ë¬¸ì œëŠ” ì•„ë‹ˆë‹¤. <br>
>ê·¸ëŸ¬ë‚˜ MSA êµ¬ì¡°ì™€ ê°™ì´ AutoScalingì´ í™œë°œí•˜ê³ , í†µì‹ ì´ ì¦ì€ ì„œë¹„ìŠ¤ì—ì„œëŠ” í•„ìˆ˜ì ìœ¼ë¡œ í•´ê²°í•˜ëŠ” ê²ƒ ê°™ë‹¤.

<br><br>

# ìœ ì˜ì‚¬í•­
1. REST API ë§Œ í˜¸ì¶œí•˜ë©´ ë˜ëŠ”ì§€?
2. DB ì¿¼ë¦¬ë„ í•œë²ˆ ìˆ˜í–‰ì„ í•´ì•¼ í•˜ëŠ”ì§€?



# ì ìš© ê²°ê³¼

ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ : api Request -> cmm request | table select > back request | table select > response
## ë¡œì»¬í™˜ê²½

ì ìš© ì „<br>
1. cmm : 380ms
2. back : 395ms
3. total response : 1043ms

<br>

ì ìš© í›„<br>
1. cmm : 37ms
2. back : 80ms
3. total response : 152ms

<br>
<br>
<br>

## ìš´ì˜í™˜ê²½

ì ìš© ì „<br>
1ì°¨ 6486ms<br>
2ì°¨ 8299ms<br>
3ì°¨ 6993ms<br>
<br>
ì ìš© í›„<br>
1ì°¨ 2102ms<br>
2ì°¨ 1798ms<br>
3ì°¨ 1405ms<br>
<br>
=> ì ìš© í›„ì—ë„ ì—¬ì „íˆ 2ì´ˆëŒ€ë¥¼ ë³´ì´ë©° ëŠë¦¬ì§€ë§Œ ì ìš© ì „ì— ë¹„í•´ í›¨ì”¬ ë¹¨ë¼ì§„ ê±¸ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.<br>
=> warm up ì„ ì ìš©í–ˆìŒì—ë„ 2ë²ˆì§¸ 3ë²ˆì§¸ ìš”ì²­ê³¼ëŠ” ì‘ë‹µ ì†ë„ê°€ ì°¨ì´ ë‚˜ëŠ” ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤. ì´ìœ ê°€ ë­˜ê¹Œ?
<br>
<br>
<br>
# ì ìš©ë°©ë²•

ì „ì œì¡°ê±´
* `/actuator/health`  í˜¸ì¶œ ì‹œ warmupì´ ëë‚˜ì•¼ UP ìƒíƒœë¡œ í•¨ê»˜ ë³€ê²½ í•´ ì£¼ì–´ì•¼ í•œë‹¤.

ApplicationWarmer.java - í•´ë‹¹ interfaceë¥¼ ìƒì†ë°›ì€ êµ¬í˜„ì²´ì˜ warmup() ë©”ì„œë“œë¥¼ ì‹¤í–‰ í•  ì˜ˆì •
```java

// warm up ì‹œ ë™ì‘í•  ë‚´ìš©ì´ ìˆë‹¤ë©´ í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì†ë°›ì•„ ë‚´ìš©ì„ êµ¬í˜„í•˜ë©´ ëœë‹¤.
public interface ApplicationWarmer {
    void warmup();
}
```

<br>
ApplicationHealthIndicator.java - `/actuator/health` í˜¸ì¶œ ì‹œ warmup ì˜ ìƒíƒœë¥¼ í™•ì¸ í›„ ìƒíƒœ(UP/DOWN)ë¥¼ ë°˜í™˜í•œë‹¤.
```java


/**
 * ApplicationHealthIndicatorConfig.java ì—ì„œ beanìœ¼ë¡œ ë“±ë¡ ëœë‹¤.
 * /actuator/health ê°€ request ë˜ë©´ doHealthCheck() ë©”ì„œë“œê°€ ì‹¤í–‰ëœë‹¤.
 * */
@Slf4j
public class ApplicationHealthIndicator extends AbstractHealthIndicator {

    private final ApplicationWarmerChecker warmer;

    public ApplicationHealthIndicator(ConfigurableApplicationContext context, ApplicationWarmerChecker warmer) {
       this.warmer = warmer;
       context.addApplicationListener(this.warmer);
    }

    @Override
    protected void doHealthCheck(Health.Builder builder) throws Exception {
       log.info("request from /actuator/health");

       if (this.warmer.checkWarmup()) {
          builder.up();
       } else {
          builder.outOfService();
       }

    }
}
```

<br>
ApplicationWarmerChecker.java - ì‹¤ì œ warmerì˜  ì‹¤í–‰ ì—¬ë¶€ë¥¼ ë°˜í™˜í•˜ë©°, ì‹¤í–‰ë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ì‹¤í–‰ í›„ ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤.
```java


/**
 * ApplicationListener<ApplicationReadyEvent> ë¥¼ ìƒì†ë°›ìŒìœ¼ë¡œ trigger í¬ì¸íŠ¸ê°€ ë‘ê°œê°€ ëœë‹¤.
 * 1. ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ ready ìƒíƒœê°€ ë˜ë©´ ì´ë²¤íŠ¸ ì‹¤í–‰
 * 2. ì•ì„œ ApplicationHealthIndicatorConfig ì—ì„œ ë“±ë¡í•œ ApplicationHealthIndicator ì—ì„œ /actuator/health requstê°€ ìš”ì²­ ë  ë•Œ ë§ˆë‹¤ ì‹¤í–‰
 *
 * í¬ì¸íŠ¸ëŠ” 2ê³³ì´ë‚˜ checkWarmup() ì—ì„œ synchronized ë¡œ lockì„ ê±¸ì–´ë‘ì–´ í•œë²ˆë§Œ ì‹¤í–‰ëœë‹¤.
 * */
@Slf4j
@Component
@RequiredArgsConstructor
public class ApplicationWarmerChecker implements ApplicationListener<ApplicationReadyEvent> {


    private final Object lockObject = new Object();
    private final AtomicBoolean completed = new AtomicBoolean(false);

    /* ApplicationWarmer ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì†ë°›ì€ ëª¨ë“  êµ¬í˜„ ê°ì²´ë¥¼ ê°€ì ¸ì˜¨ë‹¤. */
    private final List<ApplicationWarmer> applicationWarmers;

    public boolean checkWarmup() {
       synchronized (this.lockObject) {
          if (!completed.get()) {
             this.execute();
          }
          return completed.get();
       }
    }

    private void execute() {
       log.info("application warmup start");
       // ì•„ë˜ warmup(ApplicationWarmer) ë©”ì„œë“œë¥¼ ì‹¤í–‰ ì‹œí‚¨ë‹¤.
       Optional.ofNullable(applicationWarmers)
          .orElseGet(Collections::emptyList)
          .forEach(this::warmup);
       this.completed.set(true);
       log.info("application warmup completed");
    }

    private void warmup(ApplicationWarmer warmer) {
       try {
          var className = warmer.getClass().getSimpleName();
          log.info("{} - warmup start", className);
          warmer.warmup();   // ì—¬ê¸°ì„œ ApplicationWarmerë¥¼ ìƒì†ë°›ì€ ëª¨ë“  êµ¬í˜„ ê°ì²´ì˜ warmup() ë©”ì„œë“œê°€ ì‹¤í–‰ëœë‹¤.
          log.info("{} - warmup end", className);
       } catch (Exception ex) {
          log.warn("ApplicationWarmer is Failed - " + ex.getMessage());
       }
    }


    @Override
    public void onApplicationEvent(ApplicationReadyEvent event) {
       checkWarmup();
    }
}
```

<br>
ApplicationHealthIndicatorConfig.java - actuator health ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§ í•˜ê¸° ìœ„í•´ configuration ë“±ë¡í•œë‹¤.
```java


/**
 * warm up ì„ ìœ„í•œ configuration ê°ì²´
 * */
@Slf4j
@Configuration
@RequiredArgsConstructor
public class ApplicationHealthIndicatorConfig {

    /**
     * /actuator/health ê°€ request ë  ë•Œ ì´ë²¤íŠ¸ë¥¼ ë°›ëŠ” ê°ì²´
     * */
    private final ApplicationWarmerChecker warmer;

    /**
     * ApplicationWarmerChecker ê°ì²´ë¥¼ baenìœ¼ë¡œ ë“±ë¡í•´ì¤€ë‹¤.
     * */    @Bean
    ApplicationHealthIndicator applicationHealthIndicator(ApplicationContext context) {
       var configurableApplicationContext = (ConfigurableApplicationContext)context;
       return new ApplicationHealthIndicator(configurableApplicationContext, warmer);
    }

}
```

<br>
ApplicationWarmerImpl.java - ApplicationWarmer ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì†ë°›ì€ ì‹¤ì œ warmer ì‘ì—… ë‚´ìš©ì„ ì—¬ê¸° ì„œìˆ í•œë‹¤.
```java

/**
 * ì‹¤ì œ warmup() í˜¸ì¶œ ì‹œ ì‹¤í–‰ ë  ë‚´ìš©ì„ ê¸°ìˆ í•œë‹¤.
 * */
@Slf4j
@Component
@RequiredArgsConstructor
public class ApplicationWarmerImpl implements ApplicationWarmer{


    @Override
    public void warmup() { // ì‹¤ì œ warmup ë‚´ìš©ì„ êµ¬í˜„
       log.info("ApplicationWarmerImpl warmup start");

       // DB ì¿¼ë¦¬ ì‹¤í–‰ (ì‹¤í–‰ ê²°ê³¼ ì˜ë¯¸ ì—†ìŒ)


       // REST API í˜¸ì¶œ (ì‹¤í–‰ ê²°ê³¼ ì˜ë¯¸ ì—†ìŒ)


    }
}
```

